<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messka ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Font Awesome –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ -->
    <!-- Font Awesome —Å –∑–∞–ø–∞—Å–Ω—ã–º CDN -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0-beta3/css/all.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" media="none" onload="if(media!='all')media='all'">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.2s ease;
        }
        
        /* ========== –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê ========== */
        body.light-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body.light-theme .main-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        body.light-theme .chat-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        body.light-theme .other-message {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }
        
        body.light-theme .system-message {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        
        body.light-theme .online-badge {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        /* ========== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ========== */
        body.dark-theme {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-theme .main-card {
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        body.dark-theme .chat-container {
            background: #1e1e2e;
            border: 1px solid #2d2d44;
        }
        
        body.dark-theme .other-message {
            background: #2d2d44;
            color: #e0e0e0;
            border: 1px solid #3d3d5c;
        }
        
        body.dark-theme .system-message {
            background: rgba(255, 255, 255, 0.05);
            color: #a0a0a0;
        }
        
        body.dark-theme .input-group-custom {
            border-color: #3d3d5c;
        }
        
        body.dark-theme .form-control {
            background-color: #2d2d44 !important;
            color: #e0e0e0 !important;
            border: none;
        }
        
        body.dark-theme .form-control::placeholder {
            color: #a0a0a0 !important;
        }
        
        body.dark-theme .input-group-text {
            background-color: #2d2d44 !important;
            color: #667eea !important;
            border: none;
        }
        
        body.dark-theme .online-badge {
            background: rgba(255, 255, 255, 0.1);
            color: #a0a0a0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* ========== –û–ë–©–ò–ï –°–¢–ò–õ–ò ========== */
        body {
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-card {
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        .main-card:hover {
            transform: translateY(-5px);
        }
        
        .chat-container {
            height: 60vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 15px;
            scroll-behavior: smooth;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
            display: flex;
            gap: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .my-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .file-message {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .file-message a {
            color: white;
            text-decoration: underline;
        }
        
        .system-message {
            text-align: center;
            font-style: italic;
            margin: 10px 0;
            font-size: 0.9em;
            padding: 8px;
            border-radius: 20px;
        }
        
        .online-badge {
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: 600;
        }
        
        .input-group-custom {
            border-radius: 50px;
            overflow: hidden;
            border: 2px solid;
            transition: all 0.3s ease;
        }
        
        .input-group-custom:focus-within {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-custom {
            border-radius: 50px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .timestamp {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 3px;
        }
        
        .my-message .timestamp {
            color: rgba(255,255,255,0.8);
        }
        
        .header-with-line {
            display: inline-block;
            border-bottom: 3px solid #28a745;
            padding-bottom: 8px;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .dark-theme .chat-container::-webkit-scrollbar-track {
            background: #2d2d44;
        }
        
        /* ========== –ö–ù–û–ü–ö–ê –¢–ï–ú–´ ========== */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .dark-theme .theme-toggle {
            background: rgba(0,0,0,0.3);
        }
        
        /* ========== –í–´–ë–û–† –ê–í–ê–¢–ê–†–ö–ò ========== */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        
        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –¥–ª—è –±–ª–æ–∫–∞ –∞–≤–∞—Ç–∞—Ä–æ–∫ */
        body.light-theme .avatar-section {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme .avatar-section h6 {
            color: #333 !important;
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
        }
        
        .avatar-option i {
            font-size: 30px;
        }
        
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .avatar-option.selected {
            border-color: #28a745;
            transform: scale(1.05);
        }
        
        /* ========== –ö–ù–û–ü–ö–ê –ó–ê–ì–†–£–ó–ö–ò ========== */
        .upload-avatar-btn {
            background: rgba(255,255,255,0.2);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 50px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-avatar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        body.light-theme .upload-avatar-btn {
            background: #e9ecef;
            border-color: #667eea;
            color: #333;
        }
        
        body.light-theme .upload-avatar-btn:hover {
            background: #dee2e6;
        }
        
        /* ========== –§–ê–ô–õ–û–í–´–ô –ò–ù–ü–£–¢ ========== */
        .file-input-wrapper {
            position: relative;
            width: 100%;
        }
        
        .custom-file-input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        
        .custom-file-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-radius: 50px;
            border: 2px dashed;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        body.light-theme .custom-file-label {
            background: white;
            color: #212529;
            border-color: #ced4da;
        }
        
        body.dark-theme .custom-file-label {
            background: #2d2d44;
            color: #e0e0e0;
            border-color: #3d3d5c;
        }
        
        .custom-file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .custom-file-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 5px 20px;
            font-size: 0.9em;
        }
        
        /* ========== –ê–í–ê–¢–ê–†–ö–ò –í –°–û–û–ë–©–ï–ù–ò–Ø–• ========== */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message-avatar i {
            font-size: 20px;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .my-message .message-avatar {
            background: rgba(255,255,255,0.2);
        }
        
        .message-content {
            flex: 1;
        }
    </style>
</head>
<body class="light-theme">
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <i class="bi bi-sun-fill" id="themeIcon"></i>
        <span id="themeText">–°–≤–µ—Ç–ª–∞—è</span>
    </div>

    <div class="container py-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="text-center mb-5">
            <div class="mb-3">
                <i class="bi bi-chat-dots-fill" style="font-size: 3.5rem; color: white; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.2));"></i>
            </div>
            <h1 class="header-with-line text-white">
                <i class="bi bi-chat-dots-fill text-white me-2"></i>
                Messka
            </h1>
            <p class="text-white-50 mt-3">–ø—Ä–æ—Å—Ç–æ–π —á–∞—Ç</p>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="main-card p-4">
            <!-- –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω -->
            <div class="d-flex justify-content-end mb-3">
                <span class="online-badge">
                    <i class="bi bi-people-fill me-2"></i>
                    <span id="userCount">0</span> –æ–Ω–ª–∞–π–Ω
                </span>
            </div>
            
            <!-- –ß–∞—Ç -->
            <div class="chat-container mb-4" id="chatContainer">
                <div id="messages"></div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è –≤—Ö–æ–¥–∞ -->
            <div class="row" id="loginSection">
                <div class="col-md-8 mx-auto">
                    <!-- –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
                    <div class="avatar-section text-center">
                        <h6 class="text-white mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</h6>
                        <div class="avatar-grid" id="avatarGrid">
                            <div class="avatar-option default selected" onclick="selectAvatar('default', this)">
                                M
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-cat', this)">
                                <i class="fa-solid fa-cat"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-dog', this)">
                                <i class="fa-solid fa-dog"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-robot', this)">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-rocket', this)">
                                <i class="fa-solid fa-rocket"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-star', this)">
                                <i class="fa-solid fa-star"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-heart', this)">
                                <i class="fa-solid fa-heart"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-crown', this)">
                                <i class="fa-solid fa-crown"></i>
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('fa-solid fa-ghost', this)">
                                <i class="fa-solid fa-ghost"></i>
                            </div>
                        </div>
                        
                        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–µ–π –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
                        <div class="mt-3">
                            <label for="customAvatar" class="upload-avatar-btn">
                                <i class="bi bi-cloud-upload"></i>
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é
                            </label>
                            <input type="file" id="customAvatar" accept="image/*" style="display: none;" onchange="uploadCustomAvatar(event)">
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ -->
                    <div class="input-group input-group-custom">
                        <span class="input-group-text">
                            <i class="bi bi-person"></i>
                        </span>
                        <input type="text" class="form-control" id="username" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" onkeypress="if(event.key==='Enter') setUsername()">
                        <button class="btn btn-primary btn-custom" onclick="setUsername()">
                            <i class="bi bi-box-arrow-in-right me-2"></i>–í–æ–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ (—Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—Ö–æ–¥–∞) -->
            <div class="row d-none" id="chatSection">
                <div class="col-12">
                    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                    <div class="input-group input-group-custom mb-3">
                        <span class="input-group-text">
                            <i class="bi bi-chat-text"></i>
                        </span>
                        <input type="text" class="form-control" id="message" 
                               placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                               onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn btn-primary btn-custom" onclick="sendMessage()">
                            <i class="bi bi-send me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                    
                    <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
                    <div class="d-flex gap-2 align-items-center">
                        <div class="flex-grow-1 file-input-wrapper">
                            <input type="file" class="custom-file-input" id="fileInput" onchange="updateFileLabel(this)">
                            <div class="custom-file-label" id="fileLabel">
                                <span><i class="bi bi-file-earmark me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</span>
                                <span class="custom-file-button">–û–±–∑–æ—Ä</span>
                            </div>
                        </div>
                        <button class="btn btn-success btn-custom" onclick="sendFile()">
                            <i class="bi bi-paperclip me-2"></i>–§–∞–π–ª
                        </button>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>–í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü–æ–¥–≤–∞–ª -->
        <div class="text-center mt-4" style="color: rgba(255,255,255,0.7);">
            <small>¬© 2026 Messka ‚Äî —Ç–≤–æ–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —á–∞—Ç</small>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <script>
        const socket = io();
        let currentUsername = '';
        let currentAvatar = 'default';
        let users = {};

        function loadTheme() {
            const savedTheme = localStorage.getItem('messkaTheme') || 'light';
            document.body.className = savedTheme + '-theme';
            updateThemeButton(savedTheme);
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            const newTheme = isDark ? 'light' : 'dark';
            document.body.className = newTheme + '-theme';
            localStorage.setItem('messkaTheme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.className = 'bi bi-moon-fill';
                text.textContent = '–¢—ë–º–Ω–∞—è';
            } else {
                icon.className = 'bi bi-sun-fill';
                text.textContent = '–°–≤–µ—Ç–ª–∞—è';
            }
        }

        function selectAvatar(avatar, element) {
            currentAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function uploadCustomAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAvatar = e.target.result;
                    const avatarGrid = document.getElementById('avatarGrid');
                    
                    const newAvatar = document.createElement('div');
                    newAvatar.className = 'avatar-option selected';
                    newAvatar.style.backgroundImage = `url(${e.target.result})`;
                    newAvatar.style.backgroundSize = 'cover';
                    newAvatar.style.backgroundPosition = 'center';
                    newAvatar.onclick = () => selectAvatar(e.target.result, newAvatar);
                    
                    avatarGrid.appendChild(newAvatar);
                    
                    document.querySelectorAll('.avatar-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    newAvatar.classList.add('selected');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateFileLabel(input) {
            const label = document.getElementById('fileLabel').querySelector('span:first-child');
            if (input.files.length > 0) {
                label.innerHTML = `<i class="bi bi-file-earmark me-2"></i>${input.files[0].name}`;
            } else {
                label.innerHTML = '<i class="bi bi-file-earmark me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
            }
        }

        function getAvatarHtml(avatar) {
            if (avatar === 'default') {
                return '<div class="message-avatar">M</div>';
            } else if (avatar && avatar.startsWith('fa-')) {
                return `<div class="message-avatar"><i class="${avatar}"></i></div>`;
            } else if (avatar) {
                return `<div class="message-avatar"><img src="${avatar}" alt="avatar"></div>`;
            } else {
                return '<div class="message-avatar">M</div>';
            }
        }

        socket.on('connect', () => {
            addSystemMessage('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
        });

        socket.on('new_message', (msg) => {
            displayMessage(msg);
        });

        socket.on('message_history', (history) => {
            document.getElementById('messages').innerHTML = '';
            history.forEach(msg => displayMessage(msg));
        });

        socket.on('user_joined', (username) => {
            users[username] = true;
            updateUserCount();
            addSystemMessage(`üëã ${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`);
        });

        socket.on('user_left', (username) => {
            delete users[username];
            updateUserCount();
            addSystemMessage(`üëã ${username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`);
        });

        function setUsername() {
            const username = document.getElementById('username').value.trim();
            if (username) {
                currentUsername = username;
                socket.emit('set_username', { 
                    username: username,
                    avatar: currentAvatar 
                });
                
                document.getElementById('loginSection').classList.add('d-none');
                document.getElementById('chatSection').classList.remove('d-none');
                
                addSystemMessage(`‚ú® –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${username}`);
            } else {
                showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
            }
        }

        function logout() {
            currentUsername = '';
            document.getElementById('loginSection').classList.remove('d-none');
            document.getElementById('chatSection').classList.add('d-none');
            document.getElementById('username').value = '';
            addSystemMessage('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞');
        }

        function sendMessage() {
            const message = document.getElementById('message').value.trim();
            if (message && currentUsername) {
                socket.emit('send_message', { 
                    message: message,
                    avatar: currentAvatar 
                });
                document.getElementById('message').value = '';
            } else if (!currentUsername) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —á–∞—Ç!');
            }
        }

        function sendFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0 && currentUsername) {
                const file = fileInput.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    socket.emit('send_file', {
                        filename: file.name,
                        file: e.target.result,
                        avatar: currentAvatar
                    });
                    showToast(`–§–∞–π–ª "${file.name}" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...`);
                    fileInput.value = '';
                    document.getElementById('fileLabel').querySelector('span:first-child').innerHTML = '<i class="bi bi-file-earmark me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                };
                reader.readAsDataURL(file);
            } else if (!currentUsername) {
                showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —á–∞—Ç!');
            }
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            
            const time = msg.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isMine = msg.user === currentUsername;
            
            msgDiv.className = `message ${isMine ? 'my-message' : 'other-message'}`;
            
            const avatarHtml = getAvatarHtml(msg.avatar);
            
            if (msg.type === 'text') {
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${msg.user}</strong>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="mt-1">${msg.text}</div>
                    </div>
                `;
            } else {
                msgDiv.className += ' file-message';
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${msg.user}</strong>
                            <span class="timestamp">${time}</span>
                        </div>
                        <div class="mt-1">
                            <i class="bi bi-file-earmark me-2"></i>
                            <a href="${msg.filepath}" download="${msg.filename}" class="text-white">
                                ${msg.filename}
                            </a>
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.appendChild(msgDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-message';
            msgDiv.innerHTML = `<i class="bi bi-info-circle me-2"></i>${text}`;
            messagesDiv.appendChild(msgDiv);
            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        }

        function updateUserCount() {
            document.getElementById('userCount').textContent = Object.keys(users).length;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            toast.innerHTML = `
                <div class="toast show" role="alert" style="background: white; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi bi-exclamation-circle text-warning me-2"></i>
                        ${message}
                        <button type="button" class="btn-close ms-3" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        loadTheme();
    </script>
</body>
</html>