<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Messka 2.0 ‚Äî —á–∞—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0-beta3/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" media="none" onload="if(media!='all')media='all'">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: #667eea transparent;
        }
        
        /* ========== –¢–ï–ú–´ ========== */
        body.light-theme {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body.light-theme .main-card {
            background: rgba(255, 255, 255, 0.95);
        }
        
        body.light-theme .sidebar {
            background: #f8fafd;
            border-right-color: #eee;
        }
        
        body.light-theme .chat-content {
            background: #f5f7fb;
        }
        
        body.light-theme .chat-header {
            background: white;
            border-bottom-color: #eee;
        }
        
        body.light-theme .input-panel {
            background: white;
            border-top-color: #eee;
        }
        
        body.light-theme .context-menu {
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        body.light-theme .whatsnew-modal {
            background: white;
            color: #333;
        }
        
        body.light-theme .whatsnew-item {
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* ========== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ========== */
        body.dark-theme {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-theme .main-card {
            background: rgba(30, 30, 46, 0.95);
        }
        
        body.dark-theme .sidebar {
            background: #1e1e2e;
            border-right-color: #2d2d44;
        }
        
        body.dark-theme .chat-content {
            background: #1a1a2a;
        }
        
        body.dark-theme .chat-header {
            background: #2d2d44;
            border-bottom-color: #3d3d5c;
        }
        
        body.dark-theme .input-panel {
            background: #2d2d44;
            border-top-color: #3d3d5c;
        }
        
        body.dark-theme .chat-name {
            color: white !important;
        }
        
        body.dark-theme .chat-username {
            color: #a0a0a0;
        }
        
        body.dark-theme .chat-time {
            color: #666;
        }
        
        body.dark-theme .context-menu {
            background: #2d2d44;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 1px solid #3d3d5c;
        }
        
        body.dark-theme .context-menu-item:hover {
            background: #3d3d5c;
        }
        
        body.dark-theme .whatsnew-modal {
            background: #2d2d44;
            color: #e0e0e0;
        }
        
        body.dark-theme .whatsnew-item {
            background: rgba(255,255,255,0.05);
        }
        
        body.dark-theme .whatsnew-text p {
            color: #a0a0a0;
        }
        
        /* ========== –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ========== */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container-fluid {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .main-card {
            border-radius: 0;
            box-shadow: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== –®–ê–ü–ö–ê ===== */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .logo-area::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #28a745;
            border-radius: 2px;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-online {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        
        .settings-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .settings-button:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(30deg);
        }
        
        .chats-toggle {
            display: none;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        /* ===== –ö–ù–û–ü–ö–ê –ß–¢–û –ù–û–í–û–ì–û ===== */
        .whatsnew-button {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .whatsnew-button i {
            font-size: 1.1rem;
        }
        
        .whatsnew-button:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        /* ===== –ú–û–î–ê–õ–ö–ê –ß–¢–û –ù–û–í–û–ì–û ===== */
        .whatsnew-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2002;
            background: white;
            border-radius: 25px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }
        
        .whatsnew-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .whatsnew-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .whatsnew-close {
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            line-height: 1;
        }
        
        .whatsnew-close:hover {
            opacity: 1;
        }
        
        .whatsnew-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .whatsnew-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 15px;
            transition: transform 0.2s;
        }
        
        .whatsnew-item:hover {
            transform: translateX(5px);
        }
        
        .whatsnew-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .whatsnew-text {
            flex: 1;
        }
        
        .whatsnew-text h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 5px 0;
        }
        
        .whatsnew-text p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin: 0;
        }
        
        /* ===== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        body.dark-theme .modal-content {
            background: #2d2d44;
            color: white;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.4rem;
        }
        
        .close-button {
            font-size: 1.8rem;
            cursor: pointer;
            opacity: 0.7;
            line-height: 1;
        }
        
        .close-button:hover {
            opacity: 1;
        }
        
        .setting-item {
            margin: 20px 0;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-size: 1rem;
            outline: none;
            background: white;
            color: #333;
        }
        
        body.dark-theme .setting-item input,
        body.dark-theme .setting-item select {
            background: #1e1e2e;
            color: white;
            border-color: #3d3d5c;
        }
        
        .setting-item input:focus,
        .setting-item select:focus {
            border-color: #667eea;
        }
        
        .username-input-group {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 15px;
            overflow: hidden;
            background: white;
        }
        
        body.dark-theme .username-input-group {
            background: #1e1e2e;
            border-color: #3d3d5c;
        }
        
        .username-input-group span {
            padding: 12px 15px;
            background: #f0f0f0;
            font-weight: 600;
            color: #666;
        }
        
        body.dark-theme .username-input-group span {
            background: #2d2d44;
            color: #a0a0a0;
            border-right: 1px solid #3d3d5c;
        }
        
        .username-input-group input {
            flex: 1;
            border: none;
            padding: 12px 15px;
            outline: none;
            background: transparent;
            color: inherit;
        }
        
        .username-hint {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        body.dark-theme .username-hint {
            color: #a0a0a0;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            overflow: hidden;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .avatar-option i {
            font-size: 24px;
        }
        
        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .avatar-option.selected {
            border-color: #28a745;
            transform: scale(1.05);
        }
        
        .upload-avatar-btn {
            background: rgba(255,255,255,0.2);
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 50px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .upload-avatar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        body.light-theme .upload-avatar-btn {
            background: #e9ecef;
            border-color: #667eea;
            color: #333;
        }
        
        .save-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 20px;
            cursor: pointer;
        }
        
        .save-btn:hover {
            transform: scale(1.02);
        }
        
        /* ===== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ ===== */
        .context-menu {
            position: fixed;
            z-index: 3000;
            border-radius: 12px;
            overflow: hidden;
            min-width: 200px;
            display: none;
        }
        
        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .context-menu-item i {
            font-size: 1.1rem;
        }
        
        /* ===== –°–ê–ô–î–ë–ê–† ===== */
        .main-row {
            display: flex;
            flex: 1;
            min-height: 0;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 320px;
            border-right: 1px solid;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid;
            flex-shrink: 0;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 0.9rem;
            outline: none;
            background: white;
            color: #333;
        }
        
        body.dark-theme .search-box {
            background: #2d2d44;
            border-color: #3d3d5c;
            color: white;
        }
        
        .chat-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        body.dark-theme .tab-btn {
            border-color: #667eea;
            color: #a0a0a0;
        }
        
        body.dark-theme .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .find-people-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
        }
        
        .find-people-btn:hover {
            background: #667eea;
            color: white;
        }
        
        body.dark-theme .find-people-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #a0a0a0;
            border-color: #3d3d5c;
        }
        
        body.dark-theme .find-people-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 5px;
        }
        
        .chat-item:hover {
            background: #e9ecef;
        }
        
        body.dark-theme .chat-item:hover {
            background: #2d2d44;
        }
        
        .chat-item.active {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
        }
        
        body.dark-theme .chat-item.active {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-avatar i {
            font-size: 1.2rem;
        }
        
        .chat-info {
            flex: 1;
            overflow: hidden;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 3px;
            color: #333;
        }
        
        body.dark-theme .chat-name {
            color: white !important;
        }
        
        .chat-username {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        body.dark-theme .chat-username {
            color: #a0a0a0;
        }
        
        .chat-preview {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        body.dark-theme .chat-preview {
            color: #a0a0a0;
        }
        
        .chat-time {
            font-size: 0.7rem;
            color: #999;
            flex-shrink: 0;
        }
        
        body.dark-theme .chat-time {
            color: #666;
        }
        
        .unread-badge {
            background: #667eea;
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* ===== –ò–ó–ë–†–ê–ù–ù–û–ï ===== */
        .favorite-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background: white;
            color: #333;
        }
        
        body.dark-theme .favorite-item {
            background: #2d2d44 !important;
            color: #e0e0e0 !important;
            border-bottom-color: #3d3d5c !important;
        }
        
        .favorite-item:hover {
            background: rgba(102, 126, 234, 0.05) !important;
        }
        
        body.dark-theme .favorite-item:hover {
            background: #3d3d5c !important;
        }
        
        .favorite-item * {
            color: inherit;
        }
        
        .favorite-item strong {
            color: inherit !important;
        }
        
        .favorite-item small {
            color: #6c757d !important;
        }
        
        body.dark-theme .favorite-item small {
            color: #a0a0a0 !important;
        }
        
        .favorite-item div[style*="background: #f0f2f5"] {
            background: #f0f2f5 !important;
            color: #333 !important;
        }
        
        body.dark-theme .favorite-item div[style*="background: #f0f2f5"] {
            background: #1e1e2e !important;
            color: #e0e0e0 !important;
        }
        
        /* ===== –û–ë–õ–ê–°–¢–¨ –ß–ê–¢–ê ===== */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }
        
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .back-button {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #667eea;
        }
        
        body.dark-theme .back-button {
            color: #a0a0a0;
        }
        
        .chat-header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }
        
        .chat-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-header-avatar i {
            font-size: 1.2rem;
        }
        
        .chat-header-info {
            flex: 1;
        }
        
        .chat-header-info h2 {
            font-size: 1.2rem;
            margin: 0 0 3px;
            color: #333;
        }
        
        .chat-header-info p {
            font-size: 0.8rem;
            color: #666;
            margin: 0;
        }
        
        body.dark-theme .chat-header-info h2 {
            color: white;
        }
        
        body.dark-theme .chat-header-info p {
            color: #a0a0a0;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        #messages {
            display: flex;
            flex-direction: column;
        }
        
        .message {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            max-width: 70%;
            flex-shrink: 0;
            position: relative;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message-avatar i {
            font-size: 16px;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            word-break: break-word;
            cursor: context-menu;
            color: #333;
        }
        
        body.dark-theme .message-content {
            background: #2d2d44 !important;
            color: #e0e0e0 !important;
        }
        
        .my-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .my-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        body.dark-theme .my-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }
        
        .message-user {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: inherit;
        }
        
        .message-username {
            font-size: 0.7rem;
            opacity: 0.7;
            font-weight: normal;
            color: inherit;
        }
        
        .my-message .message-username {
            color: rgba(255,255,255,0.7);
        }
        
        .message-text {
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            color: inherit;
        }
        
        .message-time {
            font-size: 0.65rem;
            opacity: 0.6;
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            color: inherit;
        }
        
        .favorite-indicator {
            color: #ffc107;
            font-size: 0.8rem;
        }
        
        .file-message .message-content {
            background: #e3f2fd !important;
        }
        
        body.dark-theme .file-message .message-content {
            background: #2d2d44 !important;
        }
        
        .my-message.file-message .message-content {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .system-message {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #6c757d;
            font-size: 0.85rem;
            margin: 8px 0;
            font-style: italic;
            padding: 4px 12px;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 20px;
            align-self: center;
            max-width: 90%;
        }
        
        .system-icon {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        body.dark-theme .system-message {
            color: #a0a0a0;
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* ===== –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê ===== */
        .input-panel {
            padding: 15px 20px;
            border-top: 1px solid;
            flex-shrink: 0;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 0.95rem;
            outline: none;
        }
        
        body.dark-theme .message-input {
            background: #1e1e2e;
            border-color: #3d3d5c;
            color: white;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        .file-btn-minimal {
            width: 45px;
            height: 45px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: transparent;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .file-btn-minimal:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .file-btn-minimal input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        body.dark-theme .file-btn-minimal {
            border-color: #3d3d5c;
            color: #a0a0a0;
        }
        
        body.dark-theme .file-btn-minimal:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        /* ===== –í–´–ë–û–† –ê–í–ê–¢–ê–†–ö–ò ===== */
        .avatar-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        
        body.light-theme .avatar-section {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        /* ===== –ê–î–ê–ü–¢–ê–¶–ò–Ø ===== */
        @media (max-width: 768px) {
            .app-header {
                padding: 8px 12px;
            }
            
            .logo-icon {
                font-size: 1.3rem;
            }
            
            .logo-text {
                font-size: 1.1rem;
            }
            
            .header-online {
                display: none;
            }
            
            .settings-button {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .chats-toggle {
                display: block;
                margin-right: 5px;
                padding: 4px 10px;
                font-size: 0.8rem;
            }
            
            .whatsnew-button {
                top: 10px;
                padding: 6px 16px;
                font-size: 0.85rem;
            }
            
            .whatsnew-button i {
                font-size: 1rem;
            }
            
            .whatsnew-modal {
                padding: 20px;
                width: 95%;
            }
            
            .whatsnew-header h2 {
                font-size: 1.5rem;
            }
            
            .whatsnew-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .whatsnew-text h4 {
                font-size: 1rem;
            }
            
            .whatsnew-text p {
                font-size: 0.8rem;
            }
            
            .main-row {
                position: relative;
                height: calc(100vh - 55px);
            }
            
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .back-button {
                display: block;
                font-size: 1.3rem;
            }
            
            .chat-header {
                padding: 10px 12px;
                gap: 10px;
            }
            
            .chat-header-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .chat-header-info h2 {
                font-size: 1rem;
            }
            
            .chat-header-info p {
                font-size: 0.7rem;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-avatar {
                width: 32px;
                height: 32px;
            }
            
            .input-panel {
                padding: 10px 12px;
            }
            
            .message-input {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .send-btn, .file-btn-minimal {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .avatar-option {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body class="light-theme">
    <!-- –ö–Ω–æ–ø–∫–∞ "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ" -->
    <button class="whatsnew-button" onclick="document.getElementById('whatsnewModal').style.display='block'">
        <i class="bi bi-megaphone-fill"></i>
        <span>–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?</span>
    </button>

    <!-- –ú–æ–¥–∞–ª–∫–∞ "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ" -->
    <div class="whatsnew-modal" id="whatsnewModal">
        <div class="whatsnew-header">
            <h2>Messka 2.0</h2>
            <span class="whatsnew-close" onclick="document.getElementById('whatsnewModal').style.display='none'">&times;</span>
        </div>
        <div class="whatsnew-grid">
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-chat-dots"></i></div><div class="whatsnew-text"><h4>–õ–∏—á–Ω—ã–µ —á–∞—Ç—ã!</h4><p>–¢–µ–ø–µ—Ä—å –æ–±—â–∞—Ç—å—Å—è –º–æ–∂–Ω–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-at"></i></div><div class="whatsnew-text"><h4>Username</h4><p>–ö–∞–∂–¥—ã–π —Ç–µ–ø–µ—Ä—å —É–Ω–∏–∫–∞–ª–µ–Ω!</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-star-fill"></i></div><div class="whatsnew-text"><h4>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h4><p>–ó–∞–ø–æ–º–Ω–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã!</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-shield-lock"></i></div><div class="whatsnew-text"><h4>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4><p>–í—Å–µ –µ—â–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-key"></i></div><div class="whatsnew-text"><h4>–î–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É</h4><p>–í—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π!</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-palette"></i></div><div class="whatsnew-text"><h4>–ù–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h4><p>–ö—Ä–∞—Å–∏–≤–æ –∏ —Å—Ç–∏–ª—å–Ω–æ!</p></div></div>
            <div class="whatsnew-item"><div class="whatsnew-icon"><i class="bi bi-gear"></i></div><div class="whatsnew-text"><h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4><p>–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –Ω–∞ —Ö–æ–¥—É!</p></div></div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="addToFavoriteBtn">
            <i class="bi bi-star"></i>
            <span>–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <span class="close-button" onclick="closeSettings()">&times;</span>
            </div>
            
            <div class="setting-item">
                <label><i class="bi bi-palette me-2"></i>–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
                <select id="themeSelect" onchange="previewTheme(this.value)">
                    <option value="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
                    <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
                    <option value="auto">üîÑ –ê–≤—Ç–æ</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label><i class="bi bi-person me-2"></i>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                <input type="text" id="displayNameInput" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?" maxlength="30">
            </div>
            
            <div class="setting-item">
                <label><i class="bi bi-at me-2"></i>–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                <div class="username-input-group">
                    <span>@</span>
                    <input type="text" id="usernameTagInput" placeholder="username" maxlength="20">
                </div>
                <div class="username-hint"><i class="bi bi-info-circle"></i> –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ _</div>
            </div>
            
            <div class="setting-item">
                <label><i class="bi bi-image me-2"></i>–ê–≤–∞—Ç–∞—Ä–∫–∞</label>
                <div class="avatar-preview" id="settingsAvatarPreview">M</div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0;">
                    <div class="avatar-option" onclick="selectSettingsAvatar('default', this)">M</div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-cat', this)"><i class="fa-solid fa-cat"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-dog', this)"><i class="fa-solid fa-dog"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-robot', this)"><i class="fa-solid fa-robot"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-rocket', this)"><i class="fa-solid fa-rocket"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-star', this)"><i class="fa-solid fa-star"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-heart', this)"><i class="fa-solid fa-heart"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-crown', this)"><i class="fa-solid fa-crown"></i></div>
                    <div class="avatar-option" onclick="selectSettingsAvatar('fa-solid fa-ghost', this)"><i class="fa-solid fa-ghost"></i></div>
                </div>
                <label for="customAvatarSettings" class="upload-avatar-btn w-100 justify-content-center">
                    <i class="bi bi-cloud-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é
                </label>
                <input type="file" id="customAvatarSettings" accept="image/*" style="display: none;" onchange="uploadSettingsAvatar(event)">
            </div>
            
            <button class="save-btn" onclick="saveSettings()"><i class="bi bi-check-lg me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –ª—é–¥–µ–π -->
    <div class="modal" id="findPeopleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ù–∞–π—Ç–∏ –ª—é–¥–µ–π</h3>
                <span class="close-button" onclick="closeFindPeople()">&times;</span>
            </div>
            <div class="setting-item">
                <label><i class="bi bi-search me-2"></i>–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É</label>
                <div class="username-input-group">
                    <span>@</span>
                    <input type="text" id="searchUsernameInput" placeholder="username" oninput="searchUsers()">
                </div>
            </div>
            <div id="searchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                <div style="text-align: center; color: #6c757d; padding: 20px;">–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞</div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="main-card">
            <!-- –®–∞–ø–∫–∞ -->
            <div class="app-header">
                <div class="logo-area">
                    <i class="bi bi-chat-dots-fill logo-icon"></i>
                    <h1 class="logo-text">Messka 2.0</h1>
                </div>
                <div class="header-actions">
                    <button class="chats-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i> –ß–∞—Ç—ã</button>
                    <div class="header-online"><i class="bi bi-people-fill me-1"></i><span id="headerUserCount">0</span> –æ–Ω–ª–∞–π–Ω</div>
                    <button class="settings-button" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
                </div>
            </div>
            
            <div class="main-row">
                <!-- –°–∞–π–¥–±–∞—Ä -->
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <div class="chat-tabs">
                            <button class="tab-btn active" onclick="switchChatTab('chats', this)">–ß–∞—Ç—ã</button>
                            <button class="tab-btn" onclick="switchChatTab('favorites', this)">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        </div>
                        <button class="find-people-btn" onclick="openFindPeople()"><i class="bi bi-person-plus"></i> –ù–∞–π—Ç–∏ –ª—é–¥–µ–π</button>
                        <input type="text" class="search-box" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º..." oninput="filterChats()">
                    </div>
                    
                    <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
                    <div class="chats-list" id="chatsList">
                        <div class="chat-item active" data-chat="general" onclick="selectChat('general')">
                            <div class="chat-avatar"><i class="bi bi-people-fill"></i></div>
                            <div class="chat-info">
                                <div class="chat-name">–û–±—â–∏–π —á–∞—Ç</div>
                                <div class="chat-username">@everyone</div>
                                <div class="chat-preview" id="generalPreview">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
                            </div>
                            <div class="chat-time" id="generalTime"></div>
                        </div>
                    </div>
                    
                    <!-- –°–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                    <div class="chats-list" id="favoritesListContainer" style="display: none;"></div>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
                <div class="chat-content">
                    <!-- –°–µ–∫—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                    <div id="loginSection" style="height: 100%; display: flex; flex-direction: column;">
                        <div class="chat-header">
                            <div class="chat-header-avatar"><i class="bi bi-box-arrow-in-right"></i></div>
                            <div class="chat-header-info"><h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2><p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</p></div>
                        </div>
                        
                        <div class="messages-container" style="justify-content: center; align-items: center;">
                            <div style="max-width: 400px; width: 100%; padding: 20px;">
                                <div class="avatar-section text-center">
                                    <h6 class="mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</h6>
                                    <div class="avatar-grid" id="avatarGrid">
                                        <div class="avatar-option default selected" onclick="selectAvatar('default', this)">M</div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-cat', this)"><i class="fa-solid fa-cat"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-dog', this)"><i class="fa-solid fa-dog"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-robot', this)"><i class="fa-solid fa-robot"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-rocket', this)"><i class="fa-solid fa-rocket"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-star', this)"><i class="fa-solid fa-star"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-heart', this)"><i class="fa-solid fa-heart"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-crown', this)"><i class="fa-solid fa-crown"></i></div>
                                        <div class="avatar-option" onclick="selectAvatar('fa-solid fa-ghost', this)"><i class="fa-solid fa-ghost"></i></div>
                                    </div>
                                    <div class="mt-2">
                                        <label for="customAvatar" class="upload-avatar-btn"><i class="bi bi-cloud-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é</label>
                                        <input type="file" id="customAvatar" accept="image/*" style="display: none;" onchange="uploadCustomAvatar(event)">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label text-white">–í–∞—à–µ –∏–º—è</label>
                                    <div class="input-group input-group-custom">
                                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                                        <input type="text" class="form-control" id="registerName" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?" maxlength="30">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label text-white">–Æ–∑–µ—Ä–Ω–µ–π–º</label>
                                    <div class="username-input-group" style="border: 2px solid #ddd; border-radius: 50px;">
                                        <span>@</span>
                                        <input type="text" id="registerTag" placeholder="username" maxlength="20" onkeyup="checkUsernameAvailability()">
                                    </div>
                                    <div id="usernameStatus" class="mt-2" style="font-size: 0.9rem; color: #ffc107;">–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)</div>
                                </div>
                                
                                <button class="btn btn-primary btn-custom w-100" onclick="register()"><i class="bi bi-box-arrow-in-right me-1"></i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                            </div>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è —á–∞—Ç–∞ -->
                    <div id="chatSection" style="display: none; height: 100%; flex-direction: column;">
                        <div class="chat-header">
                            <span class="back-button" onclick="goBackToChats()"><i class="bi bi-arrow-left"></i></span>
                            <div class="chat-header-avatar" id="currentChatAvatar"><i class="bi bi-people-fill"></i></div>
                            <div class="chat-header-info">
                                <h2 id="currentChatName">–û–±—â–∏–π —á–∞—Ç</h2>
                                <p id="currentChatStatus"><span id="userCount">0</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω</p>
                            </div>
                        </div>

                        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                        <div class="messages-container" id="messagesContainer">
                            <div id="messages"></div>
                        </div>

                        <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
                        <div class="input-panel">
                            <div class="input-row">
                                <input type="text" class="message-input" id="message" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                                <div class="action-buttons">
                                    <div class="file-btn-minimal">
                                        <i class="bi bi-paperclip"></i>
                                        <input type="file" id="fileInputMinimal" onchange="handleFileSelect(this)">
                                    </div>
                                    <button class="send-btn" onclick="sendMessage()"><i class="bi bi-send"></i></button>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-outline-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i>–í—ã–π—Ç–∏</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <script>
        const socket = io();
        let currentUsername = '';
        let currentUserTag = '';
        let currentAvatar = 'default';
        let currentUserId = null;
        let currentSessionToken = localStorage.getItem('messka_session');
        let currentChat = 'general';
        let users = {};
        let selectedFile = null;
        let settingsAvatar = 'default';
        let usernameAvailable = false;
        let usernameCheckTimer = null;
        let lastCheckedTag = '';
        let contextMenuTarget = null;

        const shownSystemMessages = new Set();

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').style.display = 'none';
        });

        document.addEventListener('contextmenu', (e) => {
            const messageElement = e.target.closest('.message');
            if (!messageElement) return;
            
            e.preventDefault();
            
            const messageId = messageElement.dataset.messageId;
            const isFavorite = messageElement.dataset.isFavorite === 'true';
            
            if (!messageId) return;
            
            contextMenuTarget = {
                element: messageElement,
                id: parseInt(messageId),
                isFavorite: isFavorite
            };
            
            const menuItem = document.getElementById('addToFavoriteBtn');
            const icon = menuItem.querySelector('i');
            const text = menuItem.querySelector('span');
            
            if (isFavorite) {
                icon.className = 'bi bi-star-fill';
                text.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ';
                menuItem.style.color = '#ffc107';
            } else {
                icon.className = 'bi bi-star';
                text.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
                menuItem.style.color = '';
            }
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        });

        document.getElementById('addToFavoriteBtn').addEventListener('click', () => {
            if (!contextMenuTarget) return;
            
            const newFavoriteState = !contextMenuTarget.isFavorite;
            
            socket.emit('toggle_favorite', {
                message_id: contextMenuTarget.id,
                chat_id: currentChat,
                is_favorite: newFavoriteState
            });
            
            contextMenuTarget.element.dataset.isFavorite = newFavoriteState;
            
            const timeDiv = contextMenuTarget.element.querySelector('.message-time');
            let favIndicator = timeDiv.querySelector('.favorite-indicator');
            
            if (newFavoriteState) {
                if (!favIndicator) {
                    favIndicator = document.createElement('span');
                    favIndicator.className = 'favorite-indicator';
                    favIndicator.innerHTML = '<i class="bi bi-star-fill"></i>';
                    timeDiv.appendChild(favIndicator);
                }
            } else {
                if (favIndicator) {
                    favIndicator.remove();
                }
            }
            
            document.getElementById('contextMenu').style.display = 'none';
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
        if (currentSessionToken) {
            socket.emit('check_session', { session_token: currentSessionToken });
        }

        // ===== –¢–ï–ú–ê =====
        function loadTheme() {
            const savedTheme = localStorage.getItem('messkaTheme') || 'light';
            if (savedTheme === 'auto') {
                applyAutoTheme();
            } else {
                document.body.className = savedTheme + '-theme';
            }
            document.getElementById('themeSelect').value = savedTheme;
        }

        function applyAutoTheme() {
            const hour = new Date().getHours();
            const isDark = hour >= 19 || hour <= 6;
            document.body.className = (isDark ? 'dark' : 'light') + '-theme';
        }

        function previewTheme(theme) {
            if (theme === 'auto') {
                applyAutoTheme();
            } else {
                document.body.className = theme + '-theme';
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (localStorage.getItem('messkaTheme') === 'auto') {
                applyAutoTheme();
            }
        });

        // ===== –ü–†–û–í–ï–†–ö–ê –Æ–ó–ï–†–ù–ï–ô–ú–ê =====
        function checkUsernameAvailability() {
            const tag = document.getElementById('registerTag').value.trim().toLowerCase();
            const statusDiv = document.getElementById('usernameStatus');
            
            if (!tag) {
                statusDiv.innerHTML = '–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º';
                statusDiv.style.color = '#ffc107';
                usernameAvailable = false;
                return;
            }
            
            if (!/^[a-z0-9_]+$/.test(tag)) {
                statusDiv.innerHTML = '‚ùå –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ _';
                statusDiv.style.color = '#dc3545';
                usernameAvailable = false;
                return;
            }
            
            if (tag.length < 3) {
                statusDiv.innerHTML = '‚ùå –ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                statusDiv.style.color = '#dc3545';
                usernameAvailable = false;
                return;
            }
            
            if (tag.length > 20) {
                statusDiv.innerHTML = '‚ùå –ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤';
                statusDiv.style.color = '#dc3545';
                usernameAvailable = false;
                return;
            }
            
            if (tag === lastCheckedTag) {
                return;
            }
            
            if (usernameCheckTimer) {
                clearTimeout(usernameCheckTimer);
            }
            
            statusDiv.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            statusDiv.style.color = '#ffc107';
            
            usernameCheckTimer = setTimeout(() => {
                socket.emit('check_username', { tag: tag });
                lastCheckedTag = tag;
            }, 500);
        }

        socket.on('username_check_result', (data) => {
            const statusDiv = document.getElementById('usernameStatus');
            
            if (data.available) {
                statusDiv.innerHTML = '‚úÖ –Æ–∑–µ—Ä–Ω–µ–π–º —Å–≤–æ–±–æ–¥–µ–Ω';
                statusDiv.style.color = '#28a745';
                usernameAvailable = true;
            } else {
                if (data.reason === 'taken') {
                    statusDiv.innerHTML = '‚ùå –≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç';
                } else {
                    statusDiv.innerHTML = '‚ùå –Æ–∑–µ—Ä–Ω–µ–π–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                }
                statusDiv.style.color = '#dc3545';
                usernameAvailable = false;
            }
            
            setTimeout(() => {
                lastCheckedTag = '';
            }, 2000);
        });

        // ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
        function openSettings() {
            document.getElementById('displayNameInput').value = currentUsername;
            document.getElementById('usernameTagInput').value = currentUserTag;
            document.getElementById('themeSelect').value = localStorage.getItem('messkaTheme') || 'light';
            
            const preview = document.getElementById('settingsAvatarPreview');
            if (currentAvatar === 'default') {
                preview.innerHTML = 'M';
            } else if (currentAvatar.startsWith('fa-')) {
                preview.innerHTML = `<i class="${currentAvatar}"></i>`;
            } else {
                preview.innerHTML = `<img src="${currentAvatar}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
            const savedTheme = localStorage.getItem('messkaTheme') || 'light';
            if (savedTheme === 'auto') {
                applyAutoTheme();
            } else {
                document.body.className = savedTheme + '-theme';
            }
        }

        function selectSettingsAvatar(avatar, element) {
            settingsAvatar = avatar;
            document.querySelectorAll('#settingsModal .avatar-option').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            
            const preview = document.getElementById('settingsAvatarPreview');
            if (avatar === 'default') {
                preview.innerHTML = 'M';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else {
                preview.innerHTML = `<i class="${avatar}"></i>`;
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        function uploadSettingsAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    settingsAvatar = e.target.result;
                    const preview = document.getElementById('settingsAvatarPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveSettings() {
            const newName = document.getElementById('displayNameInput').value.trim();
            const newTag = document.getElementById('usernameTagInput').value.trim().toLowerCase();
            const newTheme = document.getElementById('themeSelect').value;
            
            if (newTag && !/^[a-z0-9_]+$/.test(newTag)) {
                alert('–Æ–∑–µ—Ä–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ _');
                return;
            }
            
            localStorage.setItem('messkaTheme', newTheme);
            if (newTheme === 'auto') {
                applyAutoTheme();
            } else {
                document.body.className = newTheme + '-theme';
            }
            
            if (newName && newName !== currentUsername && currentUsername) {
                const oldName = currentUsername;
                currentUsername = newName;
                
                socket.emit('update_profile', { 
                    username: newName,
                    tag: currentUserTag,
                    avatar: currentAvatar,
                    oldUsername: oldName
                });
                
                addSystemMessage(`‚ú® –í–∞—à–µ –∏–º—è –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ ${newName}`);
            }
            
            if (newTag && newTag !== currentUserTag && currentUsername) {
                currentUserTag = newTag;
                
                socket.emit('update_profile', { 
                    username: currentUsername,
                    tag: newTag,
                    avatar: currentAvatar
                });
                
                addSystemMessage(`üÜî –í–∞—à —é–∑–µ—Ä–Ω–µ–π–º: @${newTag}`);
            }
            
            if (settingsAvatar !== currentAvatar && currentUsername) {
                currentAvatar = settingsAvatar;
                
                socket.emit('update_profile', { 
                    username: currentUsername,
                    tag: currentUserTag,
                    avatar: currentAvatar
                });
                
                addSystemMessage(`üñºÔ∏è –í–∞—à–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
            }
            
            closeSettings();
        }

        // ===== –ü–û–ò–°–ö –õ–Æ–î–ï–ô =====
        function openFindPeople() {
            document.getElementById('findPeopleModal').style.display = 'block';
            document.getElementById('searchUsernameInput').value = '';
            document.getElementById('searchResults').innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
        }

        function closeFindPeople() {
            document.getElementById('findPeopleModal').style.display = 'none';
        }

        function searchUsers() {
            const searchTag = document.getElementById('searchUsernameInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!searchTag) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞</div>';
                return;
            }
            
            socket.emit('search_users', { tag: searchTag });
        }

        function startPrivateChat(tag) {
            socket.emit('start_private_chat', { tag: tag });
            closeFindPeople();
        }

        // ===== –ò–ó–ë–†–ê–ù–ù–û–ï =====
        function loadFavoritesList() {
            const favContainer = document.getElementById('favoritesListContainer');
            favContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            socket.emit('get_favorites');
        }

        function jumpToMessage(chatId, messageId) {
            if (chatId === 'general') {
                selectChat('general');
                setTimeout(() => {
                    const msgElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (msgElement) {
                        msgElement.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
                        msgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            msgElement.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 500);
            } else {
                socket.emit('get_chat_by_id', { chat_id: chatId, message_id: messageId });
            }
        }

        // ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö =====
        function switchChatTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (tab === 'chats') {
                document.getElementById('chatsList').style.display = 'block';
                document.getElementById('favoritesListContainer').style.display = 'none';
            } else {
                document.getElementById('chatsList').style.display = 'none';
                document.getElementById('favoritesListContainer').style.display = 'block';
                loadFavoritesList();
            }
        }

        // ===== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =====
        function register() {
            const name = document.getElementById('registerName').value.trim();
            const tag = document.getElementById('registerTag').value.trim().toLowerCase();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
                return;
            }
            
            if (!tag) {
                alert('–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º!');
                return;
            }
            
            if (!usernameAvailable) {
                alert('–Æ–∑–µ—Ä–Ω–µ–π–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.');
                return;
            }
            
            currentUsername = name;
            currentUserTag = tag;
            
            socket.emit('register', {
                username: name,
                tag: tag,
                avatar: currentAvatar
            });
        }

        // ===== –°–ò–°–¢–ï–ú–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø =====
        function addSystemMessage(text) {
            const messageKey = text;
            
            if (shownSystemMessages.has(messageKey)) {
                return;
            }
            
            shownSystemMessages.add(messageKey);
            
            setTimeout(() => {
                shownSystemMessages.delete(messageKey);
            }, 2000);
            
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-message';
            msgDiv.innerHTML = `
                <i class="bi bi-terminal-fill system-icon"></i>
                <span>${text}</span>
            `;
            messagesDiv.appendChild(msgDiv);
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
            
            updateLastMessage('system', text);
        }

        // ===== –°–ê–ô–î–ë–ê–† =====
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function goBackToChats() {
            document.getElementById('sidebar').classList.add('open');
        }

        function selectChat(chatId, chatData = null) {
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('active');
            });
            
            const chatElement = document.querySelector(`[data-chat="${chatId}"]`);
            if (chatElement) {
                chatElement.classList.add('active');
            }
            
            if (chatId === 'general') {
                currentChat = 'general';
                document.getElementById('currentChatName').textContent = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('currentChatStatus').innerHTML = `<span id="userCount">${Object.keys(users).length}</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω`;
                document.getElementById('currentChatAvatar').innerHTML = '<i class="bi bi-people-fill"></i>';
                
                document.getElementById('messages').innerHTML = '';
                socket.emit('get_message_history');
                addSystemMessage('üìç –í—ã –≤ –æ–±—â–µ–º —á–∞—Ç–µ');
            } else {
                currentChat = chatId;
                document.getElementById('currentChatName').textContent = chatData.username;
                document.getElementById('currentChatStatus').textContent = `@${chatData.tag}`;
                
                if (chatData.avatar === 'default') {
                    document.getElementById('currentChatAvatar').innerHTML = 'M';
                } else if (chatData.avatar.startsWith('fa-')) {
                    document.getElementById('currentChatAvatar').innerHTML = `<i class="${chatData.avatar}"></i>`;
                } else {
                    document.getElementById('currentChatAvatar').innerHTML = `<img src="${chatData.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                
                document.getElementById('messages').innerHTML = '';
                
                socket.emit('join_private_chat', { chat_id: chatId });
                socket.emit('get_private_chat_history', { chat_id: chatId });
                
                addSystemMessage(`üí¨ –õ–∏—á–Ω—ã–π —á–∞—Ç —Å @${chatData.tag}`);
            }
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // ===== –ê–í–ê–¢–ê–†–ö–ò =====
        function selectAvatar(avatar, element) {
            currentAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function uploadCustomAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAvatar = e.target.result;
                    const avatarGrid = document.getElementById('avatarGrid');
                    
                    const newAvatar = document.createElement('div');
                    newAvatar.className = 'avatar-option selected';
                    newAvatar.style.backgroundImage = `url(${e.target.result})`;
                    newAvatar.style.backgroundSize = 'cover';
                    newAvatar.style.backgroundPosition = 'center';
                    newAvatar.onclick = () => selectAvatar(e.target.result, newAvatar);
                    
                    avatarGrid.appendChild(newAvatar);
                    
                    document.querySelectorAll('.avatar-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    newAvatar.classList.add('selected');
                };
                reader.readAsDataURL(file);
            }
        }

        function getAvatarHtml(avatar) {
            if (avatar === 'default') {
                return '<div class="message-avatar">M</div>';
            } else if (avatar && avatar.startsWith('fa-')) {
                return `<div class="message-avatar"><i class="${avatar}"></i></div>`;
            } else if (avatar) {
                return `<div class="message-avatar"><img src="${avatar}" alt="avatar"></div>`;
            } else {
                return '<div class="message-avatar">M</div>';
            }
        }

        // ===== –§–ê–ô–õ–´ =====
        function handleFileSelect(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
            } else {
                selectedFile = null;
            }
        }

        // ===== –°–û–ö–ï–¢–´ =====
        socket.on('connect', () => {
            addSystemMessage('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
        });

        socket.on('session_result', (data) => {
            if (data.has_session) {
                currentUsername = data.user.username;
                currentUserTag = data.user.tag;
                currentAvatar = data.user.avatar;
                currentUserId = data.user.id;
                currentSessionToken = data.user.token;
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'flex';
                
                addSystemMessage(`‚ú® –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUsername} (@${currentUserTag})`);
                socket.emit('get_private_chats');
            }
        });

        socket.on('register_success', (data) => {
            currentUsername = data.user.username;
            currentUserTag = data.user.tag;
            currentAvatar = data.user.avatar;
            currentUserId = data.user.id;
            currentSessionToken = data.user.token;
            
            localStorage.setItem('messka_session', currentSessionToken);
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'flex';
            
            addSystemMessage(`‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUsername} (@${currentUserTag})`);
            socket.emit('get_private_chats');
        });

        socket.on('register_error', (data) => {
            if (data.error === 'tag_taken') {
                alert('–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π.');
                usernameAvailable = false;
                document.getElementById('usernameStatus').innerHTML = '‚ùå –Æ–∑–µ—Ä–Ω–µ–π–º –∑–∞–Ω—è—Ç';
                document.getElementById('usernameStatus').style.color = '#dc3545';
            } else {
                alert(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        });

        socket.on('new_message', (msg) => {
            if (currentChat === 'general') {
                displayMessage(msg);
                updateLastMessage(msg.user, msg.text || msg.filename);
            }
        });

        socket.on('new_private_message', (msg) => {
            if (currentChat === msg.chat_id) {
                displayPrivateMessage(msg);
            }
            updatePrivateChatPreview(msg.chat_id, msg);
        });

        socket.on('message_history', (history) => {
            if (currentChat === 'general') {
                document.getElementById('messages').innerHTML = '';
                history.forEach(msg => displayMessage(msg));
            }
        });

        socket.on('get_private_chat_history', (history) => {
            if (currentChat !== 'general') {
                document.getElementById('messages').innerHTML = '';
                history.forEach(msg => displayPrivateMessage(msg));
            }
        });

        socket.on('private_chat_started', (data) => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat', data.chat_id);
            chatItem.onclick = () => selectChat(data.chat_id, data.user);
            
            let avatarHtml = '';
            if (data.user.avatar === 'default') {
                avatarHtml = 'M';
            } else if (data.user.avatar.startsWith('fa-')) {
                avatarHtml = `<i class="${data.user.avatar}"></i>`;
            } else {
                avatarHtml = `<img src="${data.user.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            
            chatItem.innerHTML = `
                <div class="chat-avatar">${avatarHtml}</div>
                <div class="chat-info">
                    <div class="chat-name">${data.user.username}</div>
                    <div class="chat-username">@${data.user.tag}</div>
                    <div class="chat-preview">–ß–∞—Ç —Å–æ–∑–¥–∞–Ω</div>
                </div>
                <div class="chat-time"></div>
            `;
            
            document.getElementById('chatsList').appendChild(chatItem);
            selectChat(data.chat_id, data.user);
            
            data.history.forEach(msg => displayPrivateMessage(msg));
        });

        socket.on('private_chats_list', (chats) => {
            document.getElementById('chatsList').innerHTML = `
                <div class="chat-item ${currentChat === 'general' ? 'active' : ''}" data-chat="general" onclick="selectChat('general')">
                    <div class="chat-avatar"><i class="bi bi-people-fill"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">–û–±—â–∏–π —á–∞—Ç</div>
                        <div class="chat-username">@everyone</div>
                        <div class="chat-preview" id="generalPreview">${document.getElementById('generalPreview')?.textContent || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                    <div class="chat-time" id="generalTime">${document.getElementById('generalTime')?.textContent || ''}</div>
                </div>
            `;
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${currentChat === chat.chat_id ? 'active' : ''}`;
                chatItem.setAttribute('data-chat', chat.chat_id);
                chatItem.onclick = () => selectChat(chat.chat_id, chat);
                
                const unreadHtml = chat.unread_count > 0 ? `<span class="unread-badge">${chat.unread_count}</span>` : '';
                
                let avatarHtml = '';
                if (chat.avatar === 'default') {
                    avatarHtml = 'M';
                } else if (chat.avatar.startsWith('fa-')) {
                    avatarHtml = `<i class="${chat.avatar}"></i>`;
                } else {
                    avatarHtml = `<img src="${chat.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                
                chatItem.innerHTML = `
                    <div class="chat-avatar">${avatarHtml}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.username}</div>
                        <div class="chat-username">@${chat.tag}</div>
                        <div class="chat-preview">${chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                    <div class="chat-time">${chat.last_message_time || ''} ${unreadHtml}</div>
                `;
                
                document.getElementById('chatsList').appendChild(chatItem);
            });
        });

        socket.on('search_results', (results) => {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                return;
            }
            
            let html = '';
            results.forEach(user => {
                let avatarHtml = '';
                if (user.avatar === 'default') {
                    avatarHtml = 'M';
                } else if (user.avatar.startsWith('fa-')) {
                    avatarHtml = `<i class="${user.avatar}"></i>`;
                } else {
                    avatarHtml = `<img src="${user.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                
                html += `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee;">
                        <div class="chat-avatar" style="width:40px; height:40px;">${avatarHtml}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${user.username}</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">@${user.user_tag}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="startPrivateChat('${user.user_tag}')">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        });

        socket.on('favorites_list', (favorites) => {
            const favContainer = document.getElementById('favoritesListContainer');
            
            if (!favorites || favorites.length === 0) {
                favContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">üì≠ –ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }
            
            let html = '';
            favorites.forEach(fav => {
                html += `
                    <div class="favorite-item" onclick="jumpToMessage('${fav.chat_id || 'general'}', ${fav.id})">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${fav.chat_name}</strong>
                            <small style="color: #6c757d;">${fav.added_at}</small>
                        </div>
                        <div style="background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 5px;">
                            ${fav.type === 'text' ? fav.text : `<i class="bi bi-file-earmark"></i> ${fav.filename}`}
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            –æ—Ç <span style="color: #667eea;">@${fav.sender_tag}</span>
                        </div>
                    </div>
                `;
            });
            
            favContainer.innerHTML = html;
        });

        socket.on('chat_by_id_result', (data) => {
            if (data.chat_id && data.message_id) {
                selectChat(data.chat_id, data.user);
                setTimeout(() => {
                    const msgElement = document.querySelector(`.message[data-message-id="${data.message_id}"]`);
                    if (msgElement) {
                        msgElement.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
                        msgElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            msgElement.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 500);
            }
        });

        socket.on('favorite_toggled', (data) => {
            const msgElement = document.querySelector(`.message[data-message-id="${data.message_id}"]`);
            if (msgElement) {
                msgElement.dataset.isFavorite = data.is_favorite;
                
                const timeDiv = msgElement.querySelector('.message-time');
                let favIndicator = timeDiv.querySelector('.favorite-indicator');
                
                if (data.is_favorite) {
                    if (!favIndicator) {
                        favIndicator = document.createElement('span');
                        favIndicator.className = 'favorite-indicator';
                        favIndicator.innerHTML = '<i class="bi bi-star-fill"></i>';
                        timeDiv.appendChild(favIndicator);
                    }
                } else {
                    if (favIndicator) {
                        favIndicator.remove();
                    }
                }
            }
        });

        socket.on('user_joined', (data) => {
            const username = data.username;
            const tag = data.tag || '';
            const avatar = data.avatar || 'default';
            
            users[username] = { tag, avatar };
            updateUserCount();
            addSystemMessage(`üëã ${username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É${tag ? ' (@' + tag + ')' : ''}`);
        });

        socket.on('user_left', (username) => {
            delete users[username];
            updateUserCount();
            addSystemMessage(`üëã ${username} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç`);
        });

        socket.on('profile_updated', (data) => {
            if (data.old_username && data.new_username && data.old_username !== data.new_username) {
                if (users[data.old_username]) {
                    users[data.new_username] = users[data.old_username];
                    delete users[data.old_username];
                }
                addSystemMessage(`üë§ ${data.old_username} ‚Üí ${data.new_username}`);
            }
            
            if (data.new_tag) {
                addSystemMessage(`üÜî @${data.new_tag}`);
            }
        });

        // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====
        function sendMessage() {
            if (selectedFile) {
                if (currentChat === 'general') {
                    sendFile();
                } else {
                    sendPrivateFile();
                }
                return;
            }
            
            const message = document.getElementById('message').value.trim();
            if (!message || !currentUsername) return;
            
            if (currentChat === 'general') {
                socket.emit('send_message', { 
                    message: message,
                    avatar: currentAvatar,
                    tag: currentUserTag
                });
            } else {
                socket.emit('send_private_message', {
                    chat_id: currentChat,
                    message: message
                });
            }
            
            document.getElementById('message').value = '';
        }

        function sendFile() {
            if (!selectedFile || !currentUsername) return;
            
            if (selectedFile.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                selectedFile = null;
                document.getElementById('fileInputMinimal').value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('send_file', {
                    filename: selectedFile.name,
                    file: e.target.result,
                    avatar: currentAvatar,
                    tag: currentUserTag
                });
                selectedFile = null;
                document.getElementById('fileInputMinimal').value = '';
            };
            reader.readAsDataURL(selectedFile);
        }

        function sendPrivateFile() {
            if (!selectedFile || !currentUsername) return;
            
            if (selectedFile.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                selectedFile = null;
                document.getElementById('fileInputMinimal').value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('send_private_file', {
                    chat_id: currentChat,
                    filename: selectedFile.name,
                    file: e.target.result
                });
                selectedFile = null;
                document.getElementById('fileInputMinimal').value = '';
            };
            reader.readAsDataURL(selectedFile);
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.setAttribute('data-message-id', msg.id);
            msgDiv.setAttribute('data-is-favorite', msg.is_favorite || false);
            
            const time = msg.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isMine = msg.user === currentUsername;
            
            msgDiv.className = `message ${isMine ? 'my-message' : ''}`;
            
            const avatarHtml = getAvatarHtml(msg.avatar);
            
            if (msg.type === 'text') {
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content" oncontextmenu="event.preventDefault();">
                        <div class="message-user">
                            ${msg.user}
                            ${msg.tag ? `<span class="message-username">@${msg.tag}</span>` : ''}
                        </div>
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">
                            ${time}
                            ${msg.is_favorite ? '<span class="favorite-indicator"><i class="bi bi-star-fill"></i></span>' : ''}
                        </div>
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content file-message" oncontextmenu="event.preventDefault();">
                        <div class="message-user">
                            ${msg.user}
                            ${msg.tag ? `<span class="message-username">@${msg.tag}</span>` : ''}
                        </div>
                        <div class="message-text">
                            <i class="bi bi-file-earmark me-1"></i>
                            <a href="${msg.filepath}" download="${msg.filename}" style="color: inherit; text-decoration: underline;">
                                ${msg.filename}
                            </a>
                        </div>
                        <div class="message-time">
                            ${time}
                            ${msg.is_favorite ? '<span class="favorite-indicator"><i class="bi bi-star-fill"></i></span>' : ''}
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.appendChild(msgDiv);
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        }

        function displayPrivateMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            msgDiv.setAttribute('data-message-id', msg.id);
            msgDiv.setAttribute('data-is-favorite', msg.is_favorite || false);
            
            const time = msg.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isMine = msg.sender_id === currentUserId;
            
            msgDiv.className = `message ${isMine ? 'my-message' : ''}`;
            
            const avatarHtml = getAvatarHtml(msg.sender_avatar);
            
            if (msg.type === 'text') {
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content" oncontextmenu="event.preventDefault();">
                        <div class="message-user">
                            ${msg.sender_name}
                            <span class="message-username">@${msg.sender_tag}</span>
                        </div>
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">
                            ${time}
                            ${msg.is_favorite ? '<span class="favorite-indicator"><i class="bi bi-star-fill"></i></span>' : ''}
                        </div>
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content file-message" oncontextmenu="event.preventDefault();">
                        <div class="message-user">
                            ${msg.sender_name}
                            <span class="message-username">@${msg.sender_tag}</span>
                        </div>
                        <div class="message-text">
                            <i class="bi bi-file-earmark me-1"></i>
                            <a href="${msg.filepath}" download="${msg.filename}" style="color: inherit; text-decoration: underline;">
                                ${msg.filename}
                            </a>
                        </div>
                        <div class="message-time">
                            ${time}
                            ${msg.is_favorite ? '<span class="favorite-indicator"><i class="bi bi-star-fill"></i></span>' : ''}
                        </div>
                    </div>
                `;
            }
            
            messagesDiv.appendChild(msgDiv);
            document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight;
        }

        function updatePrivateChatPreview(chatId, msg) {
            const chatItem = document.querySelector(`[data-chat="${chatId}"]`);
            if (chatItem) {
                const preview = chatItem.querySelector('.chat-preview');
                const time = chatItem.querySelector('.chat-time');
                
                preview.textContent = msg.text || '–§–∞–π–ª';
                time.innerHTML = msg.time;
                
                if (msg.sender_id !== currentUserId) {
                    const unreadBadge = time.querySelector('.unread-badge');
                    if (unreadBadge) {
                        unreadBadge.textContent = parseInt(unreadBadge.textContent || 0) + 1;
                    } else {
                        time.innerHTML += ' <span class="unread-badge">1</span>';
                    }
                }
            }
        }

        function logout() {
            localStorage.removeItem('messka_session');
            currentUsername = '';
            currentUserTag = '';
            currentUserId = null;
            currentSessionToken = null;
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('chatSection').style.display = 'none';
            document.getElementById('registerName').value = '';
            document.getElementById('registerTag').value = '';
            document.getElementById('messages').innerHTML = '';
            addSystemMessage('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞');
        }

        function updateUserCount() {
            document.getElementById('userCount').textContent = Object.keys(users).length;
            document.getElementById('headerUserCount').textContent = Object.keys(users).length;
        }

        function updateLastMessage(sender, text) {
            const preview = document.getElementById('generalPreview');
            const time = document.getElementById('generalTime');
            
            if (sender === 'system') {
                preview.textContent = text;
            } else {
                preview.textContent = `${sender}: ${text}`;
            }
            
            const now = new Date();
            time.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function filterChats() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(el => {
                const name = el.querySelector('.chat-name').textContent.toLowerCase();
                if (name.includes(search)) {
                    el.style.display = 'flex';
                } else {
                    el.style.display = 'none';
                }
            });
        }

        loadTheme();
    </script>
</body>
</html>